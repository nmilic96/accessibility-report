<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accessibility Report Generator</title>
    <style>
        :root {
            --critical: #d32f2f;
            --serious: #f57c00;
            --moderate: #fbc02d;
            --minor: #1976d2;
            --bg-dark: #1a1a2e;
            --bg-card: #16213e;
            --bg-section: #0f3460;
            --text-primary: #eaeaea;
            --text-secondary: #b0b0b0;
            --accent: #e94560;
            --success: #4caf50;
            --border: #2a2a4a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, var(--bg-card) 0%, var(--bg-section) 100%);
            border-bottom: 2px solid var(--accent);
            margin-bottom: 30px;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        header p {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* File Upload Section */
        .upload-section {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 40px;
            text-align: center;
            border: 2px dashed var(--border);
            margin-bottom: 30px;
            transition: border-color 0.3s ease;
        }

        .upload-section:hover {
            border-color: var(--accent);
        }

        .upload-section.hidden {
            display: none;
        }

        .upload-section label {
            display: inline-block;
            padding: 15px 40px;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .upload-section label:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(233, 69, 96, 0.4);
        }

        .upload-section input[type="file"] {
            display: none;
        }

        .upload-section p {
            margin-top: 15px;
            color: var(--text-secondary);
        }

        /* Summary Dashboard */
        .dashboard {
            display: none;
            margin-bottom: 30px;
        }

        .dashboard.visible {
            display: block;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .dashboard-header h2 {
            font-size: 1.5rem;
        }

        .report-meta {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border-left: 4px solid var(--accent);
        }

        .stat-card.critical { border-left-color: var(--critical); }
        .stat-card.serious { border-left-color: var(--serious); }
        .stat-card.moderate { border-left-color: var(--moderate); }
        .stat-card.minor { border-left-color: var(--minor); }

        .stat-card .number {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-card.critical .number { color: var(--critical); }
        .stat-card.serious .number { color: var(--serious); }
        .stat-card.moderate .number { color: var(--moderate); }
        .stat-card.minor .number { color: var(--minor); }

        .stat-card .label {
            color: var(--text-secondary);
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 1px;
        }

        /* Top Rules */
        .top-rules {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .top-rules h3 {
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .rule-bar {
            display: flex;
            align-items: center;
            margin-bottom: 12px;
            gap: 15px;
        }

        .rule-bar .rule-name {
            width: 200px;
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--accent);
        }

        .rule-bar .bar-container {
            flex: 1;
            height: 24px;
            background: var(--bg-dark);
            border-radius: 4px;
            overflow: hidden;
        }

        .rule-bar .bar {
            height: 100%;
            background: linear-gradient(90deg, var(--accent), var(--serious));
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 10px;
            font-size: 0.8rem;
            font-weight: 600;
            min-width: 40px;
        }

        /* Filter Bar */
        .filter-bar {
            display: none;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            position: sticky;
            top: 10px;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .filter-bar.visible {
            display: block;
        }

        .filter-controls {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .filter-group label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-group select,
        .filter-group input {
            padding: 10px 15px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: var(--bg-dark);
            color: var(--text-primary);
            font-size: 0.95rem;
            min-width: 180px;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .filter-actions {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: #c73e54;
        }

        .btn-secondary {
            background: var(--bg-section);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--border);
        }

        /* Issues Sections */
        .issues-container {
            display: none;
        }

        .issues-container.visible {
            display: block;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--border);
        }

        .section-title h2 {
            font-size: 1.4rem;
        }

        .section-title .badge {
            background: var(--accent);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        /* Site-Wide Issues */
        .site-wide-section {
            background: linear-gradient(135deg, #2d1b3d 0%, #1a1a2e 100%);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            border: 1px solid #4a2c5a;
        }

        .site-wide-section .section-title {
            border-bottom-color: #4a2c5a;
        }

        .site-wide-section .section-title .badge {
            background: #9c27b0;
        }

        /* Page Accordion */
        .page-section {
            background: var(--bg-card);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            border: 1px solid var(--border);
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            cursor: pointer;
            background: var(--bg-section);
            transition: background 0.2s ease;
        }

        .page-header:hover {
            background: #1a4a7a;
        }

        .page-header .page-url {
            font-family: monospace;
            font-size: 0.95rem;
            color: var(--accent);
            word-break: break-all;
            flex: 1;
        }

        .page-header .page-stats {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .page-header .issue-count {
            background: var(--bg-dark);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .page-header .chevron {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
            color: var(--text-secondary);
        }

        .page-header.expanded .chevron {
            transform: rotate(180deg);
        }

        .page-issues {
            display: none;
            padding: 20px 25px;
        }

        .page-issues.visible {
            display: block;
        }

        /* Individual Issue */
        .issue-card {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            border-left: 4px solid var(--border);
        }

        .issue-card.critical { border-left-color: var(--critical); }
        .issue-card.serious { border-left-color: var(--serious); }
        .issue-card.moderate { border-left-color: var(--moderate); }
        .issue-card.minor { border-left-color: var(--minor); }

        .issue-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .issue-title {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .issue-title .rule-id {
            font-family: monospace;
            font-weight: 600;
            color: var(--text-primary);
        }

        .impact-badge {
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .impact-badge.critical { background: var(--critical); color: white; }
        .impact-badge.serious { background: var(--serious); color: white; }
        .impact-badge.moderate { background: var(--moderate); color: #333; }
        .impact-badge.minor { background: var(--minor); color: white; }

        .issue-actions {
            display: flex;
            gap: 10px;
        }

        .issue-actions a {
            color: var(--accent);
            text-decoration: none;
            font-size: 0.85rem;
            padding: 5px 10px;
            border: 1px solid var(--accent);
            border-radius: 4px;
            transition: all 0.2s ease;
        }

        .issue-actions a:hover {
            background: var(--accent);
            color: white;
        }

        .issue-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .issue-element {
            margin-bottom: 15px;
        }

        .issue-element label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            margin-bottom: 5px;
            letter-spacing: 0.5px;
        }

        .issue-element pre {
            background: #0d0d1a;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
            color: #7fdbca;
            border: 1px solid var(--border);
        }

        .issue-selector {
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            background: var(--bg-section);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 15px;
            word-break: break-all;
        }

        /* Fix Recommendation */
        .fix-recommendation {
            background: linear-gradient(135deg, #1a3a2a 0%, #0d1f17 100%);
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #2d5a3d;
        }

        .fix-recommendation h4 {
            color: var(--success);
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fix-recommendation h4::before {
            content: "üí°";
        }

        .fix-recommendation p {
            color: var(--text-secondary);
            margin-bottom: 15px;
            font-size: 0.95rem;
        }

        .fix-recommendation pre {
            background: #0a1510;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 0.85rem;
            color: #98c379;
            border: 1px solid #2d5a3d;
        }

        /* Affected Pages List (for site-wide issues) */
        .affected-pages {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
        }

        .affected-pages summary {
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .affected-pages ul {
            margin-top: 10px;
            padding-left: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .affected-pages li {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 5px;
        }

        /* Loading State */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .loading::after {
            content: "";
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--accent);
            border-top-color: transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 10px;
            vertical-align: middle;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state h3 {
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8rem;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .filter-controls {
                flex-direction: column;
            }

            .filter-group select,
            .filter-group input {
                width: 100%;
            }

            .filter-actions {
                margin-left: 0;
                width: 100%;
            }

            .filter-actions .btn {
                flex: 1;
            }

            .page-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .rule-bar .rule-name {
                width: 120px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>üîç Accessibility Report</h1>
        <p>Analyze and fix accessibility issues across your website</p>
    </header>

    <div class="container">
        <!-- Upload Section -->
        <div class="upload-section" id="uploadSection">
            <label for="fileInput">
                üìÇ Upload Accessibility JSON Report
            </label>
            <input type="file" id="fileInput" accept=".json">
            <p>Upload an axe DevTools JSON export to generate the report</p>
        </div>

        <!-- Dashboard -->
        <div class="dashboard" id="dashboard">
            <div class="dashboard-header">
                <h2>üìä Summary Dashboard</h2>
                <div class="report-meta" id="reportMeta"></div>
            </div>

            <div class="stats-grid" id="statsGrid"></div>

            <div class="top-rules" id="topRules">
                <h3>üèÜ Top Failing Rules</h3>
                <div id="topRulesContent"></div>
            </div>
        </div>

        <!-- Filter Bar -->
        <div class="filter-bar" id="filterBar">
            <div class="filter-controls">
                <div class="filter-group">
                    <label for="severityFilter">Severity</label>
                    <select id="severityFilter">
                        <option value="all">All Severities</option>
                        <option value="critical">Critical</option>
                        <option value="serious">Serious</option>
                        <option value="moderate">Moderate</option>
                        <option value="minor">Minor</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="ruleFilter">Rule Type</label>
                    <select id="ruleFilter">
                        <option value="all">All Rules</option>
                    </select>
                </div>

                <div class="filter-group">
                    <label for="searchInput">Search</label>
                    <input type="text" id="searchInput" placeholder="Search selector or source...">
                </div>

                <div class="filter-actions">
                    <button class="btn btn-secondary" id="expandAllBtn">Expand All</button>
                    <button class="btn btn-secondary" id="collapseAllBtn">Collapse All</button>
                    <button class="btn btn-primary" id="resetFiltersBtn">Reset Filters</button>
                </div>
            </div>
        </div>

        <!-- Issues Container -->
        <div class="issues-container" id="issuesContainer">
            <!-- Site-Wide Issues -->
            <div class="site-wide-section" id="siteWideSection">
                <div class="section-title">
                    <h2>üåê Site-Wide Issues</h2>
                    <span class="badge" id="siteWideBadge">0</span>
                </div>
                <p style="color: var(--text-secondary); margin-bottom: 20px;">
                    These issues appear on <strong>every page</strong> tested. Fixing them will improve accessibility across your entire site.
                </p>
                <div id="siteWideIssues"></div>
            </div>

            <!-- Page-Specific Issues -->
            <div class="section-title">
                <h2>üìÑ Issues by Page</h2>
                <span class="badge" id="pagesBadge">0 pages</span>
            </div>
            <div id="pagesContainer"></div>
        </div>
    </div>

    <script>
        // Fix recommendations database
        const fixRecommendations = {
            'button-name': {
                description: 'Buttons must have discernible text that describes their purpose. Screen readers announce this text to users.',
                fix: `<!-- Add visible text -->
<button>Submit Form</button>

<!-- Or use aria-label for icon buttons -->
<button aria-label="Close menu">
  <svg>...</svg>
</button>

<!-- Or use aria-labelledby -->
<button aria-labelledby="btn-label">
  <span id="btn-label" class="sr-only">Search</span>
  <svg>...</svg>
</button>`
            },
            'color-contrast': {
                description: 'Text must have sufficient color contrast against its background (4.5:1 for normal text, 3:1 for large text) to be readable by users with low vision.',
                fix: `/* Ensure sufficient contrast ratio */
/* Use a contrast checker tool */

/* Example: Change low contrast text */
.low-contrast {
  color: #767676; /* 4.54:1 against white - passes AA */
}

/* For large text (18pt+ or 14pt bold+) */
.large-text {
  color: #949494; /* 3:1 ratio acceptable for large text */
}`
            },
            'color-contrast-enhanced': {
                description: 'For WCAG AAA compliance, text must have enhanced color contrast (7:1 for normal text, 4.5:1 for large text).',
                fix: `/* Enhanced contrast for AAA compliance */
.high-contrast {
  color: #595959; /* 7:1 ratio against white */
  background: #ffffff;
}

/* Consider offering a high-contrast mode */
@media (prefers-contrast: more) {
  body {
    --text-color: #000000;
    --bg-color: #ffffff;
  }
}`
            },
            'link-name': {
                description: 'Links must have discernible text that describes their destination. Avoid generic text like "click here" or "read more".',
                fix: `<!-- Add descriptive link text -->
<a href="/products">View our products</a>

<!-- For image links, add alt text -->
<a href="/home">
  <img src="logo.png" alt="Company Name - Home">
</a>

<!-- For icon links, use aria-label -->
<a href="https://twitter.com" aria-label="Follow us on Twitter">
  <svg>...</svg>
</a>`
            },
            'image-alt': {
                description: 'Images must have alternative text that describes their content or purpose. Decorative images should have empty alt="".',
                fix: `<!-- Informative images need descriptive alt -->
<img src="chart.png" alt="Sales increased 25% in Q4 2025">

<!-- Decorative images use empty alt -->
<img src="decorative-border.png" alt="">

<!-- Complex images may need longer descriptions -->
<figure>
  <img src="diagram.png" alt="Network architecture diagram" aria-describedby="diagram-desc">
  <figcaption id="diagram-desc">Detailed description of the network...</figcaption>
</figure>`
            },
            'region': {
                description: 'All page content should be contained within landmark regions (header, nav, main, footer, etc.) to help screen reader users navigate.',
                fix: `<!-- Wrap content in landmark regions -->
<header>
  <nav aria-label="Main navigation">...</nav>
</header>

<main>
  <article>...</article>
  <aside>...</aside>
</main>

<footer>...</footer>

<!-- Or use ARIA roles -->
<div role="banner">...</div>
<div role="navigation">...</div>
<div role="main">...</div>
<div role="contentinfo">...</div>`
            },
            'heading-order': {
                description: 'Headings must be in a logical, sequential order (h1 ‚Üí h2 ‚Üí h3) without skipping levels. This helps users understand page structure.',
                fix: `<!-- Correct heading hierarchy -->
<h1>Page Title</h1>
  <h2>Section 1</h2>
    <h3>Subsection 1.1</h3>
    <h3>Subsection 1.2</h3>
  <h2>Section 2</h2>
    <h3>Subsection 2.1</h3>

<!-- Don't skip levels like this -->
<!-- ‚ùå <h1>Title</h1> <h3>Section</h3> -->

<!-- Use CSS for styling, not heading levels -->
<h2 class="small-heading">Still an h2</h2>`
            },
            'empty-heading': {
                description: 'Headings must have visible text content. Empty headings confuse screen reader users and break document structure.',
                fix: `<!-- Add text content to headings -->
<h2>Section Title</h2>

<!-- If heading contains only an image -->
<h2>
  <img src="icon.png" alt="">
  Products
</h2>

<!-- Or remove empty headings entirely -->
<!-- ‚ùå <h2></h2> -->
<!-- ‚ùå <h2>   </h2> -->`
            },
            'landmark-one-main': {
                description: 'Pages must have exactly one main landmark to identify the primary content area for screen reader users.',
                fix: `<!-- Add a main landmark -->
<main>
  <h1>Page Title</h1>
  <p>Primary page content...</p>
</main>

<!-- Or use role="main" -->
<div role="main">
  <h1>Page Title</h1>
  ...
</div>

<!-- Ensure only ONE main per page -->`
            },
            'landmark-unique': {
                description: 'Landmarks of the same type must have unique labels so screen reader users can distinguish between them.',
                fix: `<!-- Use aria-label to differentiate -->
<nav aria-label="Main navigation">...</nav>
<nav aria-label="Footer navigation">...</nav>

<!-- Or use aria-labelledby -->
<nav aria-labelledby="nav-title">
  <h2 id="nav-title">Product Categories</h2>
  ...
</nav>`
            },
            'page-has-heading-one': {
                description: 'Pages should have an h1 heading that describes the page content. This helps users understand the page purpose.',
                fix: `<!-- Add an h1 as the first heading -->
<main>
  <h1>About Our Company</h1>
  <p>Content...</p>
</main>

<!-- Only one h1 per page is recommended -->
<!-- The h1 should describe the page's main topic -->`
            },
            'list': {
                description: 'Lists must be properly structured with ul/ol containing only li elements (or script/template elements).',
                fix: `<!-- Correct list structure -->
<ul>
  <li>Item 1</li>
  <li>Item 2</li>
  <li>Item 3</li>
</ul>

<!-- Don't put non-li elements directly in ul/ol -->
<!-- ‚ùå <ul><div>Item</div></ul> -->
<!-- ‚ùå <ul><a href="#">Link</a></ul> -->

<!-- Links go inside li -->
<ul>
  <li><a href="#">Link 1</a></li>
  <li><a href="#">Link 2</a></li>
</ul>`
            },
            'listitem': {
                description: 'List items (li) must be contained within ul or ol elements to maintain proper list semantics.',
                fix: `<!-- li must be inside ul or ol -->
<ul>
  <li>Item 1</li>
  <li>Item 2</li>
</ul>

<!-- Or use role="list" on parent -->
<div role="list">
  <div role="listitem">Item 1</div>
  <div role="listitem">Item 2</div>
</div>

<!-- ‚ùå Don't use li outside of lists -->
<!-- <div><li>Orphaned item</li></div> -->`
            },
            'image-redundant-alt': {
                description: 'Image alt text should not duplicate adjacent text content. This creates unnecessary repetition for screen reader users.',
                fix: `<!-- Avoid duplicating adjacent text -->
<!-- ‚ùå Bad: -->
<img src="product.jpg" alt="Widget Pro">
<h3>Widget Pro</h3>

<!-- ‚úì Good: -->
<img src="product.jpg" alt="">
<h3>Widget Pro</h3>

<!-- Or provide additional context -->
<img src="product.jpg" alt="Widget Pro in blue finish">
<h3>Widget Pro</h3>`
            },
            'link-in-text-block': {
                description: 'Links within text blocks must be distinguishable by more than just color (e.g., underline, bold, icon) for users who cannot perceive color.',
                fix: `/* Add underline or other visual indicator */
a {
  text-decoration: underline;
}

/* Or use other distinguishing features */
a {
  text-decoration: none;
  border-bottom: 2px solid currentColor;
  font-weight: bold;
}

/* Ensure hover/focus states are also distinct */
a:hover, a:focus {
  text-decoration: underline;
  outline: 2px solid;
}`
            }
        };

        // Global state
        let reportData = null;
        let processedData = null;

        // DOM Elements
        const uploadSection = document.getElementById('uploadSection');
        const fileInput = document.getElementById('fileInput');
        const dashboard = document.getElementById('dashboard');
        const filterBar = document.getElementById('filterBar');
        const issuesContainer = document.getElementById('issuesContainer');
        const siteWideSection = document.getElementById('siteWideSection');
        const siteWideIssues = document.getElementById('siteWideIssues');
        const pagesContainer = document.getElementById('pagesContainer');
        const reportMeta = document.getElementById('reportMeta');
        const statsGrid = document.getElementById('statsGrid');
        const topRulesContent = document.getElementById('topRulesContent');
        const siteWideBadge = document.getElementById('siteWideBadge');
        const pagesBadge = document.getElementById('pagesBadge');
        const severityFilter = document.getElementById('severityFilter');
        const ruleFilter = document.getElementById('ruleFilter');
        const searchInput = document.getElementById('searchInput');

        // File upload handler
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    reportData = JSON.parse(event.target.result);
                    processReport();
                } catch (error) {
                    alert('Error parsing JSON file. Please ensure it\'s a valid axe DevTools export.');
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        // Process the report data
        function processReport() {
            if (!reportData || !reportData.allIssues) {
                alert('Invalid report format. Missing allIssues array.');
                return;
            }

            // Get all unique pages
            const pages = [...new Set(reportData.allIssues.map(i => i.testUrl))];
            const totalPages = pages.length;

            // Dedupe issues per page
            const issuesByPage = {};
            const issueSignatures = {}; // Track which pages each issue appears on

            reportData.allIssues.forEach(issue => {
                const pageUrl = issue.testUrl;
                const signature = `${issue.ruleId}|${JSON.stringify(issue.selector)}`;

                // Track pages for each signature
                if (!issueSignatures[signature]) {
                    issueSignatures[signature] = {
                        pages: new Set(),
                        issue: issue
                    };
                }
                issueSignatures[signature].pages.add(pageUrl);

                // Group by page with deduplication
                if (!issuesByPage[pageUrl]) {
                    issuesByPage[pageUrl] = new Map();
                }

                if (!issuesByPage[pageUrl].has(signature)) {
                    issuesByPage[pageUrl].set(signature, issue);
                }
            });

            // Identify site-wide issues (present on ALL pages)
            const siteWideIssuesList = [];
            const siteWideSignatures = new Set();

            Object.entries(issueSignatures).forEach(([signature, data]) => {
                if (data.pages.size === totalPages) {
                    siteWideIssuesList.push({
                        ...data.issue,
                        affectedPages: [...data.pages]
                    });
                    siteWideSignatures.add(signature);
                }
            });

            // Remove site-wide issues from page-specific lists
            Object.keys(issuesByPage).forEach(pageUrl => {
                siteWideSignatures.forEach(sig => {
                    issuesByPage[pageUrl].delete(sig);
                });
            });

            // Convert Maps to arrays and sort by severity
            const severityOrder = { critical: 0, serious: 1, moderate: 2, minor: 3 };
            Object.keys(issuesByPage).forEach(pageUrl => {
                issuesByPage[pageUrl] = [...issuesByPage[pageUrl].values()].sort((a, b) => 
                    severityOrder[a.impact] - severityOrder[b.impact]
                );
            });

            siteWideIssuesList.sort((a, b) => severityOrder[a.impact] - severityOrder[b.impact]);

            // Count issues by severity
            const severityCounts = { critical: 0, serious: 0, moderate: 0, minor: 0 };
            const ruleCounts = {};

            reportData.allIssues.forEach(issue => {
                severityCounts[issue.impact] = (severityCounts[issue.impact] || 0) + 1;
                ruleCounts[issue.ruleId] = (ruleCounts[issue.ruleId] || 0) + 1;
            });

            // Get unique rules for filter
            const uniqueRules = Object.keys(ruleCounts).sort();

            // Store processed data
            processedData = {
                pages,
                totalPages,
                issuesByPage,
                siteWideIssues: siteWideIssuesList,
                severityCounts,
                ruleCounts,
                uniqueRules,
                testName: reportData.testDetails?.testName || 'Accessibility Report',
                standard: reportData.standard,
                startDate: reportData.testingStartDate,
                endDate: reportData.testingEndDate,
                totalIssues: reportData.allIssues.length
            };

            renderReport();
        }

        // Render the report
        function renderReport() {
            if (!processedData) return;

            // Hide upload, show report
            uploadSection.classList.add('hidden');
            dashboard.classList.add('visible');
            filterBar.classList.add('visible');
            issuesContainer.classList.add('visible');

            // Render meta info
            const startDate = new Date(processedData.startDate).toLocaleDateString();
            reportMeta.innerHTML = `
                <strong>${processedData.testName}</strong> | 
                ${processedData.standard} | 
                Tested: ${startDate} | 
                ${processedData.totalPages} pages
            `;

            // Render stats
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="number">${processedData.totalIssues}</div>
                    <div class="label">Total Issues</div>
                </div>
                <div class="stat-card critical">
                    <div class="number">${processedData.severityCounts.critical || 0}</div>
                    <div class="label">Critical</div>
                </div>
                <div class="stat-card serious">
                    <div class="number">${processedData.severityCounts.serious || 0}</div>
                    <div class="label">Serious</div>
                </div>
                <div class="stat-card moderate">
                    <div class="number">${processedData.severityCounts.moderate || 0}</div>
                    <div class="label">Moderate</div>
                </div>
                <div class="stat-card minor">
                    <div class="number">${processedData.severityCounts.minor || 0}</div>
                    <div class="label">Minor</div>
                </div>
            `;

            // Render top rules
            const topRules = Object.entries(processedData.ruleCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
            const maxCount = topRules[0]?.[1] || 1;

            topRulesContent.innerHTML = topRules.map(([rule, count]) => `
                <div class="rule-bar">
                    <span class="rule-name">${rule}</span>
                    <div class="bar-container">
                        <div class="bar" style="width: ${(count / maxCount) * 100}%">${count}</div>
                    </div>
                </div>
            `).join('');

            // Populate rule filter
            ruleFilter.innerHTML = '<option value="all">All Rules</option>' +
                processedData.uniqueRules.map(rule => 
                    `<option value="${rule}">${rule}</option>`
                ).join('');

            // Render site-wide issues
            renderSiteWideIssues();

            // Render page sections
            renderPageSections();
        }

        // Render site-wide issues
        function renderSiteWideIssues() {
            const issues = getFilteredIssues(processedData.siteWideIssues);
            siteWideBadge.textContent = issues.length;

            if (issues.length === 0) {
                siteWideSection.style.display = 'none';
                return;
            }

            siteWideSection.style.display = 'block';
            siteWideIssues.innerHTML = issues.map(issue => renderIssueCard(issue, true)).join('');
        }

        // Render page sections
        function renderPageSections() {
            const severity = severityFilter.value;
            const rule = ruleFilter.value;
            const search = searchInput.value.toLowerCase();

            let pagesWithIssues = 0;
            let html = '';

            processedData.pages.forEach(pageUrl => {
                const issues = getFilteredIssues(processedData.issuesByPage[pageUrl] || []);
                
                if (issues.length === 0) return;
                pagesWithIssues++;

                html += `
                    <div class="page-section" data-url="${escapeHtml(pageUrl)}">
                        <div class="page-header" onclick="togglePageSection(this)">
                            <span class="page-url">${escapeHtml(pageUrl)}</span>
                            <div class="page-stats">
                                <span class="issue-count">${issues.length} issues</span>
                                <span class="chevron">‚ñº</span>
                            </div>
                        </div>
                        <div class="page-issues">
                            ${issues.map(issue => renderIssueCard(issue, false)).join('')}
                        </div>
                    </div>
                `;
            });

            pagesBadge.textContent = `${pagesWithIssues} pages`;
            pagesContainer.innerHTML = html || '<div class="empty-state"><h3>No issues found</h3><p>No issues match the current filters.</p></div>';
        }

        // Get filtered issues based on current filter state
        function getFilteredIssues(issues) {
            const severity = severityFilter.value;
            const rule = ruleFilter.value;
            const search = searchInput.value.toLowerCase();

            return issues.filter(issue => {
                if (severity !== 'all' && issue.impact !== severity) return false;
                if (rule !== 'all' && issue.ruleId !== rule) return false;
                if (search) {
                    const selectorStr = Array.isArray(issue.selector) ? issue.selector.join(' ') : issue.selector;
                    const searchableText = `${issue.source} ${selectorStr} ${issue.ruleId} ${issue.description}`.toLowerCase();
                    if (!searchableText.includes(search)) return false;
                }
                return true;
            });
        }

        // Render individual issue card
        function renderIssueCard(issue, isSiteWide) {
            const fix = fixRecommendations[issue.ruleId] || {
                description: issue.help,
                fix: '/* No specific fix recommendation available.\n   See the help link for guidance. */'
            };

            const selectorStr = Array.isArray(issue.selector) ? issue.selector.join(' ‚Üí ') : issue.selector;

            return `
                <div class="issue-card ${issue.impact}">
                    <div class="issue-header">
                        <div class="issue-title">
                            <span class="rule-id">${escapeHtml(issue.ruleId)}</span>
                            <span class="impact-badge ${issue.impact}">${issue.impact}</span>
                        </div>
                        <div class="issue-actions">
                            ${issue.screenshotURL ? `<a href="${escapeHtml(issue.screenshotURL)}" target="_blank">üì∑ View Screenshot</a>` : ''}
                            <a href="${escapeHtml(issue.helpUrl)}" target="_blank">üìñ Learn More</a>
                        </div>
                    </div>
                    
                    <p class="issue-description">${escapeHtml(issue.description)}</p>
                    
                    <div class="issue-element">
                        <label>Affected Element</label>
                        <pre>${escapeHtml(issue.source)}</pre>
                    </div>
                    
                    <div class="issue-selector">
                        <strong>Selector:</strong> ${escapeHtml(selectorStr)}
                    </div>
                    
                    <div class="fix-recommendation">
                        <h4>How to Fix</h4>
                        <p>${escapeHtml(fix.description)}</p>
                        <pre>${escapeHtml(fix.fix)}</pre>
                    </div>
                    
                    ${isSiteWide && issue.affectedPages ? `
                        <details class="affected-pages">
                            <summary>Affects all ${issue.affectedPages.length} tested pages</summary>
                            <ul>
                                ${issue.affectedPages.map(url => `<li>${escapeHtml(url)}</li>`).join('')}
                            </ul>
                        </details>
                    ` : ''}
                </div>
            `;
        }

        // Toggle page section
        function togglePageSection(header) {
            header.classList.toggle('expanded');
            const issues = header.nextElementSibling;
            issues.classList.toggle('visible');
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Filter handlers
        severityFilter.addEventListener('change', applyFilters);
        ruleFilter.addEventListener('change', applyFilters);
        searchInput.addEventListener('input', debounce(applyFilters, 300));

        function applyFilters() {
            renderSiteWideIssues();
            renderPageSections();
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Expand/Collapse all
        document.getElementById('expandAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.page-header').forEach(header => {
                header.classList.add('expanded');
                header.nextElementSibling.classList.add('visible');
            });
        });

        document.getElementById('collapseAllBtn').addEventListener('click', () => {
            document.querySelectorAll('.page-header').forEach(header => {
                header.classList.remove('expanded');
                header.nextElementSibling.classList.remove('visible');
            });
        });

        // Reset filters
        document.getElementById('resetFiltersBtn').addEventListener('click', () => {
            severityFilter.value = 'all';
            ruleFilter.value = 'all';
            searchInput.value = '';
            applyFilters();
        });
    </script>
</body>
</html>
